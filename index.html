<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ØµØ±ÙˆÙØ§ØªÙŠ Ø¨Ø±Ùˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
    --bg: #f4f1ec;
    --card: #ffffff;
    --ink: #1a1a1a;
    --accent: #c8a96e;
    --green: #2d6a4f;
    --red: #e63946;
    --muted: #888;
    --border: #e8e3db;
}
* { margin:0; padding:0; box-sizing:border-box; font-family:'Tajawal',sans-serif; }
body { background:var(--bg); color:var(--ink); }

/* TOAST */
#toast {
    position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px);
    background:var(--ink); color:#fff; padding:12px 28px; border-radius:50px;
    font-size:15px; font-weight:700; z-index:9999;
    transition:transform .3s cubic-bezier(.34,1.56,.64,1);
    pointer-events:none;
}
#toast.show { transform:translateX(-50%) translateY(0); }

/* AUTH */
#authScreen {
    min-height:100vh; display:flex; align-items:center; justify-content:center;
    background:var(--ink);
}
.auth-box {
    background:var(--card); border-radius:28px; padding:44px 36px;
    width:92%; max-width:420px; box-shadow:0 20px 60px rgba(0,0,0,0.4);
}
.auth-logo { text-align:center; font-size:52px; margin-bottom:6px; }
.auth-title { text-align:center; font-size:26px; font-weight:900; margin-bottom:4px; }
.auth-sub { text-align:center; color:var(--muted); font-size:14px; margin-bottom:30px; }
.field { margin-bottom:14px; }
.field label { display:block; font-size:12px; font-weight:700; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.5px; }
.field input { width:100%; padding:14px 16px; border:2px solid var(--border); border-radius:12px; font-size:16px; font-family:'Tajawal',sans-serif; background:var(--bg); transition:border-color .2s; }
.field input:focus { outline:none; border-color:var(--accent); }
.btn-main { width:100%; padding:15px; background:var(--ink); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:800; cursor:pointer; font-family:'Tajawal',sans-serif; margin-top:6px; transition:opacity .2s; }
.btn-main:hover { opacity:.85; }
.auth-link { text-align:center; margin-top:16px; font-size:14px; color:var(--muted); }
.auth-link span { color:var(--accent); font-weight:700; cursor:pointer; }

/* BANNER */
#setupBanner {
    display:none; background:#fffbea; border:2px solid var(--accent);
    border-radius:16px; margin:16px; padding:16px 20px; font-size:13px; line-height:2;
}
#setupBanner.show { display:block; }
#setupBanner strong { color:var(--ink); }
#setupBanner a { color:var(--green); font-weight:700; }

/* APP */
#mainApp { display:none; min-height:100vh; }

.header {
    background:var(--ink); color:#fff; padding:18px 20px 20px;
    position:sticky; top:0; z-index:100;
}
.header-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
.header-title { font-size:20px; font-weight:900; }
.header-sub { font-size:13px; color:rgba(255,255,255,.5); }
.btn-logout { background:rgba(255,255,255,.1); border:none; color:#fff; padding:8px 14px; border-radius:20px; cursor:pointer; font-size:13px; font-family:'Tajawal',sans-serif; }

.nav-btns { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:8px; }
.nbtn { padding:11px 8px; border:none; border-radius:10px; font-size:14px; font-weight:700; cursor:pointer; font-family:'Tajawal',sans-serif; transition:opacity .2s; }
.nbtn:hover { opacity:.85; }
.nbtn-add    { background:var(--accent); color:var(--ink); }
.nbtn-cards  { background:rgba(255,255,255,.12); color:#fff; }
.nbtn-budget { background:rgba(45,106,79,.7); color:#fff; }
.nbtn-cats   { background:rgba(255,255,255,.07); color:rgba(255,255,255,.8); }

/* BUDGET BAR */
.budget-wrap { margin:16px; background:var(--card); border-radius:18px; padding:18px; box-shadow:0 3px 16px rgba(0,0,0,.07); display:none; }
.bw-top { display:flex; justify-content:space-between; margin-bottom:10px; }
.bw-label { font-size:14px; font-weight:700; }
.bw-pct { font-size:22px; font-weight:900; }
.bw-track { background:var(--border); border-radius:99px; height:9px; }
.bw-fill { height:100%; border-radius:99px; transition:width .6s ease; }
.bw-meta { display:flex; justify-content:space-between; margin-top:8px; font-size:12px; color:var(--muted); }

/* STATS */
.stats { display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:0 16px 16px; }
.scard { background:var(--card); border-radius:16px; padding:18px; box-shadow:0 3px 16px rgba(0,0,0,.07); }
.scard-label { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; }
.scard-val { font-size:22px; font-weight:900; }

/* EXPENSES */
.section { padding:0 16px 80px; }
.section-title { font-size:15px; font-weight:800; margin-bottom:12px; }
.exp-item {
    background:var(--card); border-radius:16px; padding:16px;
    margin-bottom:10px; box-shadow:0 3px 16px rgba(0,0,0,.07);
    display:flex; justify-content:space-between; align-items:flex-start;
    border-right:4px solid var(--accent);
}
.ei-cat { font-size:15px; font-weight:800; margin-bottom:3px; }
.ei-sub { font-size:12px; color:var(--accent); font-weight:600; margin-bottom:8px; }
.ei-badges { display:flex; gap:6px; flex-wrap:wrap; }
.badge { font-size:11px; background:var(--bg); color:var(--muted); padding:3px 9px; border-radius:20px; font-weight:600; }
.ei-right { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
.ei-amount { font-size:18px; font-weight:900; white-space:nowrap; }
.ei-edit { background:none; border:none; font-size:20px; cursor:pointer; padding:2px 6px; border-radius:8px; }
.ei-edit:active { background:#dbeafe; }
.ei-del { background:none; border:none; font-size:20px; cursor:pointer; padding:2px 6px; border-radius:8px; }
.ei-del:active { background:#fee2e2; }
.empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
.empty-icon { font-size:56px; margin-bottom:12px; }
.empty-txt { font-size:17px; font-weight:700; }

/* MODAL */
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:500; align-items:flex-end; justify-content:center; }
.modal.open { display:flex; }
.modal-body {
    background:var(--card); border-radius:24px 24px 0 0; padding:28px 20px 50px;
    width:100%; max-width:600px; max-height:92vh; overflow-y:auto;
    animation:up .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes up { from{transform:translateY(100%)} to{transform:translateY(0)} }
.mhandle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:0 auto 20px; }
.mtitle { font-size:20px; font-weight:900; margin-bottom:22px; }
.flabel { display:block; font-size:12px; font-weight:700; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.5px; }
.finput, .fselect, .ftextarea {
    width:100%; padding:13px 14px; border:2px solid var(--border);
    border-radius:12px; font-size:16px; font-family:'Tajawal',sans-serif;
    background:var(--bg); margin-bottom:14px; transition:border-color .2s;
}
.finput:focus, .fselect:focus, .ftextarea:focus { outline:none; border-color:var(--accent); }
.ftextarea { resize:vertical; min-height:72px; }
.btn-save { width:100%; padding:15px; background:var(--ink); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:800; cursor:pointer; font-family:'Tajawal',sans-serif; margin-bottom:8px; }
.btn-cancel { width:100%; padding:13px; background:var(--border); color:var(--muted); border:none; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:'Tajawal',sans-serif; margin-bottom:8px; }
.btn-danger { width:100%; padding:13px; background:#fee2e2; color:var(--red); border:none; border-radius:12px; font-size:15px; font-weight:800; cursor:pointer; font-family:'Tajawal',sans-serif; margin-bottom:8px; }

/* CARD ROW */
.crd-row { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; background:var(--bg); border-radius:12px; margin-bottom:8px; }
.crd-name { font-size:16px; font-weight:700; }
.crd-del { background:var(--red); color:#fff; border:none; border-radius:10px; padding:10px 20px; font-size:15px; font-weight:800; cursor:pointer; font-family:'Tajawal',sans-serif; min-width:80px; }
</style>
</head>
<body>

<div id="toast"></div>

<!-- Ø¥Ø¹Ø¯Ø§Ø¯ Supabase -->
<div id="setupBanner">
    <strong>âš™ï¸ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</strong><br>
    Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Supabase)ØŒ Ø§ØªØ¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙÙŠ Ù…Ù„Ù <strong>SUPABASE_SETUP.md</strong> Ø§Ù„Ù…Ø±ÙÙ‚.
</div>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="authScreen">
    <div class="auth-box">
        <div class="auth-logo">ğŸ’°</div>
        <div class="auth-title">Ù…ØµØ±ÙˆÙØ§ØªÙŠ Ø¨Ø±Ùˆ</div>
        <div class="auth-sub">Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙÙƒ Ø¨Ø°ÙƒØ§Ø¡</div>
        <div id="loginForm">
            <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="lEmail" placeholder="you@email.com"></div>
            <div class="field"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="lPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
            <button class="btn-main" onclick="doLogin()">Ø¯Ø®ÙˆÙ„ â†</button>
            <div class="auth-link">Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø­Ø³Ø§Ø¨ØŸ <span onclick="showReg()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span></div>
        </div>
        <div id="regForm" style="display:none">
            <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="rName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„"></div>
            <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input type="email" id="rEmail" placeholder="you@email.com"></div>
            <div class="field"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="rPass" placeholder="6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"></div>
            <button class="btn-main" onclick="doRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ â†</button>
            <div class="auth-link">Ø¹Ù†Ø¯Ùƒ Ø­Ø³Ø§Ø¨ØŸ <span onclick="showLogin()">Ø¯Ø®ÙˆÙ„</span></div>
        </div>
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="mainApp">
    <div class="header">
        <div class="header-top">
            <div>
                <div class="header-title">ğŸ’° Ù…ØµØ±ÙˆÙØ§ØªÙŠ Ø¨Ø±Ùˆ</div>
                <div class="header-sub">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="hName"></span></div>
            </div>
            <button class="btn-logout" onclick="doLogout()">Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>
        <div class="nav-btns">
            <button class="nbtn nbtn-add"    onclick="openAddModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
            <button class="nbtn nbtn-cards"  onclick="openCardsModal()">ğŸ’³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
            <button class="nbtn nbtn-budget" onclick="openBudgetModal()">ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>
            <button class="nbtn nbtn-cats"   onclick="openCatsModal()">ğŸ“‚ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</button>
            <button class="nbtn nbtn-reports" onclick="openReportsModal()" style="background:rgba(255,255,255,.12);color:#fff;">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        </div>
    </div>

    <div class="budget-wrap" id="budgetWrap">
        <div class="bw-top">
            <span class="bw-label">ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</span>
            <span class="bw-pct" id="bPct">0%</span>
        </div>
        <div class="bw-track"><div class="bw-fill" id="bFill" style="width:0%"></div></div>
        <div class="bw-meta">
            <span>Ù…ØµØ±ÙˆÙ: <b id="bSpent">0</b> ï·¼</span>
            <span>Ù…ØªØ¨Ù‚ÙŠ: <b id="bLeft">0</b> ï·¼</span>
        </div>
    </div>

    <!-- Search Bar -->
    <div style="padding:0 20px 16px;">
        <div style="position:relative;">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¨Ù„ØºØŒ ØªØµÙ†ÙŠÙØŒ ÙˆØµÙ..." 
                style="width:100%;padding:14px 45px 14px 16px;border:2px solid var(--border);border-radius:12px;font-size:15px;font-family:'Tajawal',sans-serif;background:var(--card);"
                oninput="searchExpenses()"
            >
            <button 
                id="clearSearch"
                onclick="clearSearch()" 
                style="position:absolute;left:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;display:none;"
            >Ã—</button>
        </div>
    </div>

    <div class="stats">
        <div class="scard"><div class="scard-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="scard-val" id="sTotal">0 ï·¼</div></div>
        <div class="scard"><div class="scard-label">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div><div class="scard-val" id="sCount">0</div></div>
        <div class="scard"><div class="scard-label">Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ</div><div class="scard-val" id="sAvg">0 ï·¼</div></div>
        <div class="scard"><div class="scard-label">Ø£ÙƒØ¨Ø± ØªØµÙ†ÙŠÙ</div><div class="scard-val" id="sTop" style="font-size:15px">-</div></div>
    </div>

    <div class="section">
        <div class="section-title">ğŸ“‹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
        <div id="expList"><div style="text-align:center;padding:40px;color:var(--muted)">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ -->
<div class="modal" id="addModal">
    <div class="modal-body">
        <div class="mhandle"></div>
        <div class="mtitle">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</div>
        <label class="flabel">Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„) *</label>
        <input type="number" id="eAmt" class="finput" placeholder="0.00" step="0.01">
        <label class="flabel">Ø§Ù„ØªØµÙ†ÙŠÙ *</label>
        <select id="eCat" class="fselect" onchange="fillSubs()"></select>
        <label class="flabel">Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ</label>
        <select id="eSub" class="fselect"></select>
        <label class="flabel">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© *</label>
        <select id="eCard" class="fselect"></select>
        <label class="flabel">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
        <input type="date" id="eDate" class="finput">
        <label class="flabel">Ø§Ù„ÙˆØµÙ</label>
        <textarea id="eDesc" class="ftextarea" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ..."></textarea>
        <button class="btn-save" onclick="saveExpense()">âœ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        <button class="btn-cancel" onclick="closeModal('addModal')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
<div class="modal" id="cardsModal">
    <div class="modal-body">
        <div class="mhandle"></div>
        <div class="mtitle">ğŸ’³ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div>
        <label class="flabel">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
        <select id="cType" class="fselect">
            <option value="Ù†Ù‚Ø¯ÙŠ">ğŸ’µ Ù†Ù‚Ø¯ÙŠ</option>
            <option value="Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†ÙƒÙŠØ©">ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†ÙƒÙŠØ©</option>
            <option value="ÙÙŠØ²Ø§">ğŸ’³ ÙÙŠØ²Ø§</option>
            <option value="Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯">ğŸ’³ Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯</option>
            <option value="Ù…Ø­ÙØ¸Ø©">ğŸ“± Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
        </select>
        <label class="flabel">Ø§Ù„Ø¨Ù†Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <select id="cBank" class="fselect" onchange="toggleCustomBank()">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option>Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ</option><option>Ø§Ù„Ø£Ù‡Ù„ÙŠ</option><option>Ø§Ù„Ø±ÙŠØ§Ø¶</option>
            <option>Ø³Ø§Ù…Ø¨Ø§</option><option>Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡</option><option>Ø§Ù„Ø¨Ù„Ø§Ø¯</option>
            <option>Ø§Ù„Ø¬Ø²ÙŠØ±Ø©</option><option>STC Bank</option><option>stc pay</option>
            <option>Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„ÙˆØ·Ù†ÙŠ</option><option>Ø³Ø§Ø¨</option>
            <option>Ø§Ù„ÙØ±Ù†Ø³ÙŠ</option><option>Ø§Ù„Ø®Ù„ÙŠØ¬</option>
            <option value="__custom__">ğŸ¦ Ø¨Ù†Ùƒ Ø¢Ø®Ø±...</option>
        </select>
        <div id="customBankDiv" style="display:none;margin-top:10px;">
            <input type="text" id="cBankCustom" class="finput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ...">
        </div>
        <label class="flabel">Ø§Ø³Ù… Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="text" id="cNick" class="finput" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">
        <button class="btn-save" onclick="addCard()">âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
        <div class="section-title" style="margin:18px 0 10px">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        <div id="cardsList"></div>
        <button class="btn-cancel" onclick="closeModal('cardsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© -->
<div class="modal" id="budgetModal">
    <div class="modal-body">
        <div class="mhandle"></div>
        <div class="mtitle">ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
            <div>
                <label class="flabel">Ø§Ù„Ø³Ù†Ø©</label>
                <select id="budgetYear" class="fselect" onchange="loadBudgetForPeriod()"></select>
            </div>
            <div>
                <label class="flabel">Ø§Ù„Ø´Ù‡Ø±</label>
                <select id="budgetMonth" class="fselect" onchange="loadBudgetForPeriod()">
                    <option value="01">ÙŠÙ†Ø§ÙŠØ±</option>
                    <option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option>
                    <option value="03">Ù…Ø§Ø±Ø³</option>
                    <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option>
                    <option value="05">Ù…Ø§ÙŠÙˆ</option>
                    <option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
                    <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option>
                    <option value="08">Ø£ØºØ³Ø·Ø³</option>
                    <option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                    <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                    <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                    <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                </select>
            </div>
        </div>
        
        <label class="flabel">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±ÙŠØ§Ù„)</label>
        <input type="number" id="budgetVal" class="finput" placeholder="Ù…Ø«Ø§Ù„: 10000">
        <button class="btn-save" onclick="saveBudget()">âœ… Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>
        <button class="btn-danger" onclick="clearBudget()">ğŸ—‘ï¸ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>
        <button class="btn-cancel" onclick="closeModal('budgetModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª -->
<div class="modal" id="catsModal">
    <div class="modal-body" style="max-width:700px;">
        <div class="mhandle"></div>
        <div class="mtitle">ğŸ“‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</div>
        
        <!-- Add Main Category -->
        <div style="background:var(--bg);padding:16px;border-radius:12px;margin-bottom:20px;">
            <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;color:var(--accent);">â• Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ Ø±Ø¦ÙŠØ³ÙŠ</h3>
            <label class="flabel">Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ</label>
            <input type="text" id="catName" class="finput" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ù†Ø²Ù„">
            
            <label class="flabel">Ø§Ø®ØªØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
            <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:6px;margin-bottom:12px;" id="iconPicker"></div>
            
            <label class="flabel">Ø£Ùˆ Ø§ÙƒØªØ¨ Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
            <input type="text" id="catIcon" class="finput" placeholder="ğŸ " style="text-align:center;font-size:28px;height:60px;">
            
            <button class="btn-save" onclick="addMainCat()">âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</button>
        </div>

        <!-- Add Subcategory -->
        <div style="background:#e8f5e9;padding:16px;border-radius:12px;margin-bottom:20px;">
            <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;color:#2d6a4f;">â• Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ ÙØ±Ø¹ÙŠ</h3>
            <label class="flabel">Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
            <select id="subCatParent" class="fselect"></select>
            
            <label class="flabel">Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ</label>
            <input type="text" id="subCatName" class="finput" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù…Ø§Ø¡ØŒ ØºØ§Ø²...">
            
            <button onclick="addSubCat()" style="width:100%;padding:14px;background:#2d6a4f;color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ
            </button>
        </div>
        
        <div class="section-title" style="margin:18px 0 10px">ğŸ“‹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        <div id="catsList"></div>
        <button class="btn-cancel" onclick="closeModal('catsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<style>
.icon-btn {
    background:var(--card);
    border:2px solid var(--border);
    border-radius:8px;
    padding:10px;
    font-size:26px;
    cursor:pointer;
    transition:all .15s;
    display:flex;
    align-items:center;
    justify-content:center;
}
.icon-btn:hover {
    border-color:var(--accent);
    transform:scale(1.15);
}
.icon-btn.selected {
    border-color:var(--accent);
    background:var(--accent);
    transform:scale(1.1);
}
.sub-item {
    background:#f8f9fa;
    padding:8px 12px;
    border-radius:8px;
    margin:4px 0 4px 20px;
    font-size:13px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.sub-item:hover {
    background:#e9ecef;
}
</style>

<!-- Reports Modal -->
<div class="modal" id="reportsModal">
    <div class="modal-body" style="max-width:900px;">
        <div class="mhandle"></div>
        <div class="mtitle">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
        
        <!-- Period Filter -->
        <div style="background:#e3f2fd;padding:16px;border-radius:12px;margin-bottom:20px;">
            <div style="font-size:14px;font-weight:800;margin-bottom:12px;color:#1565c0;">ğŸ“… Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø©</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <select id="repYear" class="fselect" onchange="updateReports()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
                </select>
                <select id="repMonth" class="fselect" onchange="updateReports()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
                    <option value="01">ÙŠÙ†Ø§ÙŠØ±</option>
                    <option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option>
                    <option value="03">Ù…Ø§Ø±Ø³</option>
                    <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option>
                    <option value="05">Ù…Ø§ÙŠÙˆ</option>
                    <option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
                    <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option>
                    <option value="08">Ø£ØºØ³Ø·Ø³</option>
                    <option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                    <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                    <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                    <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                </select>
                <button onclick="resetPeriod()" style="background:var(--muted);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">
            <div style="background:var(--bg);padding:16px;border-radius:12px;">
                <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                <div id="repTotal" style="font-size:22px;font-weight:900;">0 ï·¼</div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:12px;">
                <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                <div id="repCount" style="font-size:22px;font-weight:900;">0</div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:12px;">
                <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
                <div id="repAvg" style="font-size:22px;font-weight:900;">0 ï·¼</div>
            </div>
        </div>

        <!-- Monthly Trend Chart -->
        <div style="background:var(--bg);padding:20px;border-radius:16px;margin-bottom:20px;">
            <h3 style="font-size:16px;font-weight:800;margin-bottom:16px;">ğŸ“ˆ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
            <canvas id="monthlyChart" style="max-height:250px;"></canvas>
        </div>

        <!-- Pie Chart -->
        <div style="background:var(--bg);padding:20px;border-radius:16px;margin-bottom:20px;">
            <h3 style="font-size:16px;font-weight:800;margin-bottom:16px;">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ</h3>
            <canvas id="pieChart" style="max-height:300px;"></canvas>
        </div>

        <!-- Category Breakdown -->
        <div style="background:var(--bg);padding:20px;border-radius:16px;margin-bottom:20px;">
            <h3 style="font-size:16px;font-weight:800;margin-bottom:16px;">ğŸ“‹ Ø§Ù„ØªÙØµÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ</h3>
            <div id="catBreakdown"></div>
        </div>

        <!-- Statements Buttons -->
        <div style="margin-bottom:20px;">
            <h3 style="font-size:16px;font-weight:800;margin-bottom:12px;">ğŸ—‚ï¸ ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <button onclick="showCardStatement()" style="padding:14px;background:#1565c0;color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                    ğŸ’³ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                </button>
                <button onclick="showCategoryStatement()" style="padding:14px;background:#7b1fa2;color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                    ğŸ“‚ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
                </button>
            </div>
        </div>

        <!-- Export Buttons -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;">
            <button onclick="shareReport()" style="padding:14px;background:var(--green);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©
            </button>
            <button onclick="exportPDF()" style="padding:14px;background:var(--red);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                ğŸ“„ PDF
            </button>
            <button onclick="exportExcel()" style="padding:14px;background:#00796b;color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                ğŸ“Š Excel
            </button>
        </div>

        <button class="btn-cancel" onclick="closeModal('reportsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Card Statement Modal -->
<div class="modal" id="cardStatementModal">
    <div class="modal-body" style="max-width:800px;">
        <div class="mhandle"></div>
        <div class="mtitle">ğŸ’³ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div>
        
        <label class="flabel">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
        <select id="statCardSelect" class="fselect" onchange="renderCardStatement()"></select>
        
        <!-- Period Filter -->
        <div style="background:#e3f2fd;padding:16px;border-radius:12px;margin:16px 0;">
            <div style="font-size:14px;font-weight:800;margin-bottom:12px;color:#1565c0;">ğŸ“… ÙÙ„ØªØ±Ø© Ø§Ù„ÙØªØ±Ø©</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <select id="cardStatYear" class="fselect" onchange="renderCardStatement()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
                </select>
                <select id="cardStatMonth" class="fselect" onchange="renderCardStatement()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
                    <option value="01">ÙŠÙ†Ø§ÙŠØ±</option>
                    <option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option>
                    <option value="03">Ù…Ø§Ø±Ø³</option>
                    <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option>
                    <option value="05">Ù…Ø§ÙŠÙˆ</option>
                    <option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
                    <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option>
                    <option value="08">Ø£ØºØ³Ø·Ø³</option>
                    <option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                    <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                    <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                    <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                </select>
                <button onclick="resetCardStatementPeriod()" style="background:var(--muted);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>
        
        <div id="cardStatementContent" style="margin-top:20px;"></div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px;">
            <button onclick="exportCardStatement()" style="padding:14px;background:var(--green);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                ğŸ“¥ ØªØµØ¯ÙŠØ± Excel
            </button>
            <button onclick="printCardStatement()" style="padding:14px;background:var(--ink);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>
        
        <button class="btn-cancel" onclick="closeModal('cardStatementModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Category Statement Modal -->
<div class="modal" id="categoryStatementModal">
    <div class="modal-body" style="max-width:800px;">
        <div class="mhandle"></div>
        <div class="mtitle">ğŸ“‚ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</div>
        
        <label class="flabel">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</label>
        <select id="statCatSelect" class="fselect" onchange="renderCategoryStatement()"></select>
        
        <!-- Period Filter -->
        <div style="background:#e3f2fd;padding:16px;border-radius:12px;margin:16px 0;">
            <div style="font-size:14px;font-weight:800;margin-bottom:12px;color:#1565c0;">ğŸ“… ÙÙ„ØªØ±Ø© Ø§Ù„ÙØªØ±Ø©</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <select id="catStatYear" class="fselect" onchange="renderCategoryStatement()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
                </select>
                <select id="catStatMonth" class="fselect" onchange="renderCategoryStatement()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
                    <option value="01">ÙŠÙ†Ø§ÙŠØ±</option>
                    <option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option>
                    <option value="03">Ù…Ø§Ø±Ø³</option>
                    <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option>
                    <option value="05">Ù…Ø§ÙŠÙˆ</option>
                    <option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
                    <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option>
                    <option value="08">Ø£ØºØ³Ø·Ø³</option>
                    <option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                    <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                    <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                    <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                </select>
                <button onclick="resetCategoryStatementPeriod()" style="background:var(--muted);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>
        
        <div id="categoryStatementContent" style="margin-top:20px;"></div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px;">
            <button onclick="exportCategoryStatement()" style="padding:14px;background:var(--green);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                ğŸ“¥ ØªØµØ¯ÙŠØ± Excel
            </button>
            <button onclick="printCategoryStatement()" style="padding:14px;background:var(--ink);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:800;cursor:pointer;font-family:'Tajawal',sans-serif;">
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>
        
        <button class="btn-cancel" onclick="closeModal('categoryStatementModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// âš™ï¸  Ø¨ÙŠØ§Ù†Ø§Øª Supabase (Ù…ÙØ¹Ø¯Ù‘Ø© ÙˆÙ…ÙØ¹Ù‘Ù„Ø©)
const SUPA_URL = 'https://jqicgsosodptrnwjdjrh.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxaWNnc29zb2RwdHJud2pkanJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzM3NDEsImV4cCI6MjA4NjkwOTc0MX0.1kdVLTmOvkctApKR3l6jdztFgg9dCAHRL-1ediW0bIY';
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const LOCAL_MODE = SUPA_URL === 'YOUR_SUPABASE_URL';
let db = null;
if (!LOCAL_MODE) db = supabase.createClient(SUPA_URL, SUPA_KEY);

// State
let user = null;
let expenses = [];
let cards    = [];
let budgets  = {}; // Period-based budgets: { "2025-02": 10000, "2025-03": 12000 }
let cats = {
    'Ù…ÙˆØ§ØµÙ„Ø§Øª': { icon:'ğŸš—', subs:['Ø¨Ù†Ø²ÙŠÙ†','ØµÙŠØ§Ù†Ø©','Ù‚Ø·Ø¹ ØºÙŠØ§Ø±','ØºØ³ÙŠÙ„','ØªØ£Ù…ÙŠÙ†','Ø£Ø¬Ø±Ø©'] },
    'Ø¥ÙŠØ¬Ø§Ø±'  : { icon:'ğŸ ', subs:['Ø´Ù‚Ø©','Ù…ÙƒØªØ¨','Ø³ÙŠØ§Ø±Ø©','ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø³ÙƒÙ†'] },
    'ÙÙˆØ§ØªÙŠØ±' : { icon:'ğŸ“±', subs:['Ø¬ÙˆØ§Ù„','Ø¥Ù†ØªØ±Ù†Øª','ÙƒÙ‡Ø±Ø¨Ø§Ø¡','Ù…Ø§Ø¡','ØºØ§Ø²'] },
    'Ø·Ø¹Ø§Ù…'   : { icon:'ğŸ½ï¸', subs:['Ù…Ø·Ø§Ø¹Ù…','Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª','ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©','Ù…Ù‚Ø§Ù‡ÙŠ','ØªÙˆØµÙŠÙ„'] },
    'ØµØ­Ø©'    : { icon:'ğŸ’Š', subs:['Ø£Ø¯ÙˆÙŠØ©','Ø¹ÙŠØ§Ø¯Ø§Øª','Ù…Ø³ØªØ´ÙÙŠØ§Øª','ØªØ£Ù…ÙŠÙ† ØµØ­ÙŠ','ÙØ­ÙˆØµØ§Øª'] },
    'ØªØ³ÙˆÙ‚'   : { icon:'ğŸ›ï¸', subs:['Ù…Ù„Ø§Ø¨Ø³','Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª','Ø£Ø«Ø§Ø«','Ù‡Ø¯Ø§ÙŠØ§'] },
    'ØªØ±ÙÙŠÙ‡'  : { icon:'ğŸ®', subs:['Ø³ÙŠÙ†Ù…Ø§','Ø£Ù„Ø¹Ø§Ø¨','Ø±ÙŠØ§Ø¶Ø©','Ø³ÙØ±','Ù‡ÙˆØ§ÙŠØ§Øª'] },
    'ØªØ¹Ù„ÙŠÙ…'  : { icon:'ğŸ“š', subs:['ÙƒØªØ¨','Ø¯ÙˆØ±Ø§Øª','Ø±Ø³ÙˆÙ… Ø¯Ø±Ø§Ø³ÙŠØ©','Ù‚Ø±Ø·Ø§Ø³ÙŠØ©'] },
};

// â”€â”€ Toast â”€â”€
function toast(msg, type='ok') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.background = type === 'err' ? '#e63946' : type === 'ok' ? '#2d6a4f' : '#1a1a1a';
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2600);
}

// â”€â”€ LocalStorage helpers â”€â”€
const LS = {
    get: k  => JSON.parse(localStorage.getItem(`mp_${user?.id}_${k}`) || 'null'),
    set: (k,v) => localStorage.setItem(`mp_${user?.id}_${k}`, JSON.stringify(v)),
    del: k  => localStorage.removeItem(`mp_${user?.id}_${k}`),
};

// â”€â”€ Auth â”€â”€
function showReg()   { document.getElementById('loginForm').style.display='none';  document.getElementById('regForm').style.display='block'; }
function showLogin() { document.getElementById('loginForm').style.display='block'; document.getElementById('regForm').style.display='none'; }

async function doLogin() {
    const email = document.getElementById('lEmail').value.trim();
    const pass  = document.getElementById('lPass').value;
    if (!email || !pass) { toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±','err'); return; }

    if (LOCAL_MODE) {
        const users = JSON.parse(localStorage.getItem('mp_users') || '[]');
        const u = users.find(x => x.email===email && x.password===pass);
        if (!u) { toast('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©','err'); return; }
        startApp(u);
    } else {
        const { data, error } = await db.auth.signInWithPassword({ email, password: pass });
        if (error) { toast(error.message,'err'); return; }
        const m = data.user.user_metadata;
        startApp({ id: data.user.id, name: m.name||email, email });
    }
}

async function doRegister() {
    const name  = document.getElementById('rName').value.trim();
    const email = document.getElementById('rEmail').value.trim();
    const pass  = document.getElementById('rPass').value;
    if (!name||!email||!pass) { toast('Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','err'); return; }
    if (pass.length < 6) { toast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø©','err'); return; }

    if (LOCAL_MODE) {
        const users = JSON.parse(localStorage.getItem('mp_users') || '[]');
        if (users.find(x => x.email===email)) { toast('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹','err'); return; }
        const u = { id: Date.now().toString(), name, email, password: pass };
        users.push(u);
        localStorage.setItem('mp_users', JSON.stringify(users));
        startApp(u);
    } else {
        const { error } = await db.auth.signUp({ email, password: pass, options:{ data:{ name } } });
        if (error) { toast(error.message,'err'); return; }
        toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ ğŸ“§');
    }
}

function startApp(u) {
    user = u;
    localStorage.setItem('mp_current', JSON.stringify(u));
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('hName').textContent = u.name;
    if (LOCAL_MODE) document.getElementById('setupBanner').classList.add('show');
    loadAll();
}

async function doLogout() {
    if (!confirm('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) return;
    localStorage.removeItem('mp_current');
    if (!LOCAL_MODE && db) await db.auth.signOut();
    location.reload();
}

// â”€â”€ Load All â”€â”€
async function loadAll() {
    if (LOCAL_MODE) {
        expenses = LS.get('expenses') || [];
        cards    = LS.get('cards')    || [];
        budgets  = LS.get('budgets')  || {};
        const sc = LS.get('cats');
        if (sc) cats = sc;
    } else {
        await loadFromDB();
    }
    if (!cards.length) {
        const defaultCard = { id:'cash', user_id: user.id, name:'Ù†Ù‚Ø¯ÙŠ', type:'Ù†Ù‚Ø¯ÙŠ' };
        cards = [defaultCard];
        LS.set('cards', cards);
        if (!LOCAL_MODE && db) await db.from('cards').insert([defaultCard]);
    }
    allExpenses = expenses.slice(); // Backup for search
    renderAll();
}

async function loadFromDB() {
    try {
        const uid = user.id;
        const [eR, cR, bR, catR] = await Promise.all([
            db.from('expenses').select('*').eq('user_id',uid).order('date',{ascending:false}),
            db.from('cards').select('*').eq('user_id',uid),
            db.from('budgets').select('*').eq('user_id',uid),
            db.from('categories').select('*').eq('user_id',uid),
        ]);
        expenses = eR.data || [];
        cards    = cR.data || [];
        
        // Convert budgets array to object { "2025-02": 10000 }
        budgets = {};
        if (bR.data) {
            bR.data.forEach(b => {
                if (b.period) budgets[b.period] = b.amount;
            });
        }
        
        if (catR.data?.length) {
            cats = {};
            catR.data.forEach(c => cats[c.name] = { icon:c.icon, subs:c.subs||[] });
        }
    } catch(e) { console.error(e); }
}

// â”€â”€ Render â”€â”€
function renderAll() { renderStats(); renderBudget(); renderExpenses(); }

function renderStats() {
    const expensesToUse = allExpenses.length > 0 ? allExpenses : expenses;
    const total = expensesToUse.reduce((s,e) => s+(+e.amount||0), 0);
    const catT  = {};
    expensesToUse.forEach(e => { const c=e.main_cat||''; if(c) catT[c]=(catT[c]||0)+(+e.amount||0); });
    const top = Object.keys(catT).sort((a,b) => catT[b]-catT[a])[0] || '-';
    const avg = expensesToUse.length ? (total/30).toFixed(0) : 0;

    document.getElementById('sTotal').textContent = total.toLocaleString('ar-SA') + ' ï·¼';
    document.getElementById('sCount').textContent = expensesToUse.length;
    document.getElementById('sAvg').textContent   = (+avg).toLocaleString('ar-SA') + ' ï·¼';
    document.getElementById('sTop').textContent   = top!=='-' && cats[top] ? cats[top].icon+' '+top : '-';
}

function renderBudget() {
    const m = new Date().toISOString().slice(0,7); // Current month YYYY-MM
    const currentBudget = budgets[m];
    
    if (!currentBudget) { 
        document.getElementById('budgetWrap').style.display='none'; 
        return; 
    }
    
    const spent = expenses.filter(e=>(e.date||'').slice(0,7)===m).reduce((s,e)=>s+(+e.amount||0),0);
    const pct   = Math.min(Math.round(spent/currentBudget*100),100);
    const left  = Math.max(currentBudget-spent,0);
    const fill  = document.getElementById('bFill');
    fill.style.width = pct+'%';
    fill.style.background = pct<70 ? '#2d6a4f' : pct<90 ? '#e9c46a' : '#e63946';
    document.getElementById('bPct').textContent   = pct+'%';
    document.getElementById('bSpent').textContent = spent.toLocaleString('ar-SA');
    document.getElementById('bLeft').textContent  = left.toLocaleString('ar-SA');
    document.getElementById('budgetWrap').style.display = 'block';
}

function renderExpenses() {
    const el = document.getElementById('expList');
    if (!expenses.length) {
        el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-txt">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯</div></div>`;
        return;
    }
    el.innerHTML = expenses.map(exp => {
        const c    = cats[exp.main_cat] || { icon:'ğŸ“¦' };
        const card = cards.find(x => String(x.id)===String(exp.card_id)) || { name:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' };
        const d    = exp.date ? new Date(exp.date).toLocaleDateString('ar-EG',{year:'numeric',month:'short',day:'numeric'}) : '';
        return `
        <div class="exp-item">
            <div style="flex:1">
                <div class="ei-cat">${c.icon} ${exp.main_cat||''}</div>
                ${exp.sub_cat ? `<div class="ei-sub">${exp.sub_cat}</div>` : ''}
                <div class="ei-badges">
                    <span class="badge">ğŸ’³ ${card.name||card.type}</span>
                    <span class="badge">ğŸ“… ${d}</span>
                    ${exp.description ? `<span class="badge">ğŸ“ ${exp.description}</span>` : ''}
                </div>
            </div>
            <div class="ei-right">
                <div class="ei-amount">${(+exp.amount).toLocaleString('ar-SA')} ï·¼</div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="ei-edit" onclick="editExpense('${exp.id}')">âœï¸</button>
                    <button class="ei-del" onclick="confirmDelete('${exp.id}')">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

// Separate confirm delete function
function confirmDelete(id) {
    const exp = expenses.find(e => String(e.id) === String(id));
    if (!exp) return;
    
    const confirmMsg = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ\n\n${exp.main_cat}${exp.sub_cat ? ' / ' + exp.sub_cat : ''}\n${exp.amount} Ø±ÙŠØ§Ù„`;
    
    if (confirm(confirmMsg)) {
        delExpense(id);
    }
}

// â”€â”€ Search â”€â”€
let allExpenses = [];

function searchExpenses() {
    const query = document.getElementById('searchInput').value.trim().toLowerCase();
    const clearBtn = document.getElementById('clearSearch');
    
    if (query === '') {
        clearBtn.style.display = 'none';
        expenses = allExpenses.slice();
        renderExpenses();
        return;
    }
    
    clearBtn.style.display = 'block';
    
    expenses = allExpenses.filter(e => {
        const amount = String(e.amount || '').toLowerCase();
        const mainCat = String(e.main_cat || '').toLowerCase();
        const subCat = String(e.sub_cat || '').toLowerCase();
        const desc = String(e.description || '').toLowerCase();
        const card = cards.find(c => String(c.id) === String(e.card_id));
        const cardName = card ? String(card.name || card.type || '').toLowerCase() : '';
        
        return amount.includes(query) || 
               mainCat.includes(query) || 
               subCat.includes(query) || 
               desc.includes(query) ||
               cardName.includes(query);
    });
    
    renderExpenses();
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    expenses = allExpenses.slice();
    renderExpenses();
}

// â”€â”€ Expense â”€â”€
function openAddModal() {
    const cSel = document.getElementById('eCat');
    cSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>';
    Object.keys(cats).forEach(c => cSel.innerHTML += `<option value="${c}">${cats[c].icon} ${c}</option>`);
    document.getElementById('eSub').innerHTML = '<option value="">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</option>';

    const kSel = document.getElementById('eCard');
    kSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>';
    cards.forEach(c => kSel.innerHTML += `<option value="${c.id}">${c.name||c.type}</option>`);

    document.getElementById('eDate').valueAsDate = new Date();
    
    // Reset form for new expense
    delete document.getElementById('addModal').dataset.editId;
    const saveBtn = document.querySelector('#addModal .btn-save');
    if (saveBtn) {
        saveBtn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ';
        saveBtn.onclick = saveExpense;
    }
    
    openModal('addModal');
}

function fillSubs() {
    const cat = document.getElementById('eCat').value;
    const sel = document.getElementById('eSub');
    sel.innerHTML = '<option value="">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</option>';
    if (cat && cats[cat]) cats[cat].subs.forEach(s => sel.innerHTML += `<option>${s}</option>`);
}

async function saveExpense() {
    const amt  = parseFloat(document.getElementById('eAmt').value);
    const cat  = document.getElementById('eCat').value;
    const sub  = document.getElementById('eSub').value;
    const cid  = document.getElementById('eCard').value;
    const date = document.getElementById('eDate').value;
    const desc = document.getElementById('eDesc').value.trim();

    if (!amt||!cat||!cid||!date) { toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© âš ï¸','err'); return; }

    const exp = { id: Date.now().toString(), user_id:user.id, amount:amt, main_cat:cat, sub_cat:sub, card_id:cid, date, description:desc };

    if (!LOCAL_MODE && db) {
        const { data, error } = await db.from('expenses').insert([exp]).select().single();
        if (error) { toast('Ø®Ø·Ø£: '+error.message,'err'); return; }
        expenses.unshift(data);
    } else {
        expenses.unshift(exp);
        LS.set('expenses', expenses);
    }

    allExpenses = expenses.slice(); // Update backup
    ['eAmt','eDesc'].forEach(id => document.getElementById(id).value='');
    document.getElementById('eCat').value='';
    document.getElementById('eSub').innerHTML='<option>Ø§Ø®ØªÙŠØ§Ø±ÙŠ</option>';
    closeModal('addModal');
    renderAll();
    toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ');
}

async function delExpense(id) {
    expenses = expenses.filter(e => String(e.id) !== String(id));
    allExpenses = expenses.slice(); // Update backup
    if (!LOCAL_MODE && db) await db.from('expenses').delete().eq('id', id);
    else LS.set('expenses', expenses);
    renderAll();
    toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');
}

function editExpense(id) {
    const exp = allExpenses.find(e => String(e.id) === String(id));
    if (!exp) {
        toast('Ø§Ù„Ù…ØµØ±ÙˆÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','err');
        return;
    }
    
    // Fill category dropdown
    const cSel = document.getElementById('eCat');
    cSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>';
    Object.keys(cats).forEach(c => cSel.innerHTML += `<option value="${c}">${cats[c].icon} ${c}</option>`);
    
    // Fill card dropdown
    const kSel = document.getElementById('eCard');
    kSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>';
    cards.forEach(c => kSel.innerHTML += `<option value="${c.id}">${c.name||c.type}</option>`);
    
    // Fill the form with existing data
    document.getElementById('eAmt').value = exp.amount;
    document.getElementById('eDate').value = exp.date;
    document.getElementById('eDesc').value = exp.description || '';
    document.getElementById('eCard').value = exp.card_id;
    
    // Set category
    document.getElementById('eCat').value = exp.main_cat;
    fillSubCatOptions(); // Update sub-category options
    
    // Set sub-category
    if (exp.sub_cat) {
        setTimeout(() => {
            const subSelect = document.getElementById('eSub');
            if (subSelect) {
                const option = Array.from(subSelect.options).find(opt => opt.value === exp.sub_cat);
                if (option) subSelect.value = exp.sub_cat;
            }
        }, 100);
    }
    
    // Store the ID for updating
    document.getElementById('addModal').dataset.editId = id;
    
    // Change button text
    const saveBtn = document.querySelector('#addModal .btn-save');
    if (saveBtn) {
        saveBtn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        saveBtn.onclick = updateExpense;
    }
    
    openModal('addModal');
}

async function updateExpense() {
    const id = document.getElementById('addModal').dataset.editId;
    if (!id) return;
    
    const amt  = parseFloat(document.getElementById('eAmt').value);
    const cat  = document.getElementById('eCat').value;
    const sub  = document.getElementById('eSub').value;
    const cid  = document.getElementById('eCard').value;
    const date = document.getElementById('eDate').value;
    const desc = document.getElementById('eDesc').value.trim();

    if (!amt||!cat||!cid||!date) { toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© âš ï¸','err'); return; }

    // Update in arrays
    const expIndex = expenses.findIndex(e => String(e.id) === String(id));
    const allExpIndex = allExpenses.findIndex(e => String(e.id) === String(id));
    
    if (expIndex !== -1) {
        expenses[expIndex] = { ...expenses[expIndex], amount:amt, main_cat:cat, sub_cat:sub, card_id:cid, date, description:desc };
    }
    if (allExpIndex !== -1) {
        allExpenses[allExpIndex] = { ...allExpenses[allExpIndex], amount:amt, main_cat:cat, sub_cat:sub, card_id:cid, date, description:desc };
    }

    // Save to database
    if (!LOCAL_MODE && db) {
        await db.from('expenses').update({ 
            amount:amt, main_cat:cat, sub_cat:sub, card_id:cid, date, description:desc 
        }).eq('id', id);
    } else {
        LS.set('expenses', expenses);
    }

    // Reset form
    ['eAmt','eDesc'].forEach(id => document.getElementById(id).value='');
    document.getElementById('eCat').value='';
    document.getElementById('eSub').innerHTML='<option>Ø§Ø®ØªÙŠØ§Ø±ÙŠ</option>';
    delete document.getElementById('addModal').dataset.editId;
    
    // Reset button
    const saveBtn = document.querySelector('#addModal .btn-save');
    if (saveBtn) {
        saveBtn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ';
        saveBtn.onclick = saveExpense;
    }
    
    closeModal('addModal');
    renderAll();
    toast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ');
}

// â”€â”€ Cards â”€â”€
function openCardsModal() {
    renderCards();
    openModal('cardsModal');
}

function renderCards() {
    const el = document.getElementById('cardsList');
    if (!cards.length) { el.innerHTML='<p style="color:var(--muted);text-align:center;padding:16px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª</p>'; return; }
    el.innerHTML = '';
    cards.forEach((card, idx) => {
        const row = document.createElement('div');
        row.className = 'crd-row';
        const nm = document.createElement('span');
        nm.className = 'crd-name';
        nm.textContent = card.name || card.type;
        const btn = document.createElement('button');
        btn.className = 'crd-del';
        btn.textContent = 'ğŸ—‘ï¸ Ø­Ø°Ù';
        btn.addEventListener('touchend', e => { e.preventDefault(); e.stopPropagation(); doDeleteCard(idx); });
        btn.addEventListener('click',    e => { e.preventDefault(); e.stopPropagation(); doDeleteCard(idx); });
        row.appendChild(nm);
        row.appendChild(btn);
        el.appendChild(row);
    });
}

function doDeleteCard(idx) {
    const card = cards[idx];
    cards.splice(idx, 1);
    LS.set('cards', cards);
    if (!LOCAL_MODE && db) db.from('cards').delete().eq('id', card.id);
    renderCards();
    toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©','info');
}

function toggleCustomBank() {
    const bank = document.getElementById('cBank').value;
    const customDiv = document.getElementById('customBankDiv');
    if (bank === '__custom__') {
        customDiv.style.display = 'block';
    } else {
        customDiv.style.display = 'none';
        document.getElementById('cBankCustom').value = '';
    }
}

async function addCard() {
    const type = document.getElementById('cType').value;
    let bank = document.getElementById('cBank').value;
    
    // Handle custom bank
    if (bank === '__custom__') {
        const customBank = document.getElementById('cBankCustom').value.trim();
        if (!customBank) {
            toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ','err');
            return;
        }
        bank = customBank;
    }
    
    const nick = document.getElementById('cNick').value.trim();
    const name = nick || (bank ? `${type} ${bank}` : type);
    const card = { id: Date.now().toString(), user_id: user.id, type, bank, name };
    cards.push(card);
    LS.set('cards', cards);
    if (!LOCAL_MODE && db) await db.from('cards').insert([card]);
    document.getElementById('cType').value = 'Ù†Ù‚Ø¯ÙŠ';
    document.getElementById('cBank').value = '';
    document.getElementById('cNick').value = '';
    document.getElementById('cBankCustom').value = '';
    document.getElementById('customBankDiv').style.display = 'none';
    renderCards();
    toast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©');
}

// â”€â”€ Budget â”€â”€
let currentBudgetPeriod = '';

function openBudgetModal() {
    fillBudgetYears();
    setCurrentPeriod();
    loadBudgetForPeriod();
    openModal('budgetModal');
}

function fillBudgetYears() {
    const currentYear = new Date().getFullYear();
    const years = [currentYear - 1, currentYear, currentYear + 1];
    const sel = document.getElementById('budgetYear');
    sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    sel.value = currentYear;
}

function setCurrentPeriod() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    document.getElementById('budgetYear').value = year;
    document.getElementById('budgetMonth').value = month;
}

function loadBudgetForPeriod() {
    const year = document.getElementById('budgetYear').value;
    const month = document.getElementById('budgetMonth').value;
    currentBudgetPeriod = `${year}-${month}`;
    
    const amount = budgets[currentBudgetPeriod] || '';
    document.getElementById('budgetVal').value = amount;
}

async function saveBudget() {
    const v = parseFloat(document.getElementById('budgetVal').value);
    if (!v || v <= 0) { toast('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹','err'); return; }
    
    const year = document.getElementById('budgetYear').value;
    const month = document.getElementById('budgetMonth').value;
    const period = `${year}-${month}`;
    
    budgets[period] = v;
    LS.set('budgets', budgets);
    
    if (!LOCAL_MODE && db) {
        await db.from('budgets').upsert([{ 
            user_id: user.id, 
            period: period,
            amount: v 
        }]);
    }
    
    closeModal('budgetModal');
    renderBudget();
    toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©');
}

async function clearBudget() {
    const year = document.getElementById('budgetYear').value;
    const month = document.getElementById('budgetMonth').value;
    const period = `${year}-${month}`;
    
    delete budgets[period];
    LS.set('budgets', budgets);
    
    if (!LOCAL_MODE && db) {
        await db.from('budgets').delete().match({ user_id: user.id, period: period });
    }
    
    closeModal('budgetModal');
    renderBudget();
    toast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©','info');
}

// â”€â”€ Categories â”€â”€
const iconsList = ['ğŸ ','ğŸš—','ğŸ½ï¸','ğŸ’Š','ğŸ›ï¸','ğŸ®','ğŸ“š','ğŸ“±','ğŸ’°','âš¡','ğŸ’§','ğŸ”¥','âœˆï¸','ğŸ‹ï¸','ğŸ¨','ğŸµ','ğŸ‘•','ğŸ•','â˜•','ğŸ','ğŸ’»','ğŸ¥','âš½','ğŸŒ³','ğŸ–ï¸','ğŸ¬','ğŸ“¸','ğŸ›ï¸','ğŸš¿','ğŸ”§','ğŸ”Œ','ğŸ“º','ğŸ¯','ğŸ†','ğŸ’¡','ğŸŒŸ','â¤ï¸','ğŸ‚','ğŸ”','ğŸ¨'];
let selectedIcon = '';

function openCatsModal() {
    renderIconPicker();
    fillSubCatParentSelect();
    renderCats();
    openModal('catsModal');
}

function renderIconPicker() {
    const picker = document.getElementById('iconPicker');
    if (!picker) return;
    picker.innerHTML = iconsList.map(icon => 
        `<button type="button" class="icon-btn" onclick="selectIcon('${icon}')">${icon}</button>`
    ).join('');
}

function selectIcon(icon) {
    selectedIcon = icon;
    document.getElementById('catIcon').value = icon;
    document.querySelectorAll('.icon-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.textContent === icon);
    });
}

function fillSubCatParentSelect() {
    const select = document.getElementById('subCatParent');
    if (!select) return;
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...</option>';
    Object.keys(cats).forEach(c => {
        select.innerHTML += `<option value="${c}">${cats[c].icon} ${c}</option>`;
    });
}

function renderCats() {
    const list = document.getElementById('catsList');
    if (!list) return;
    
    const html = Object.keys(cats).map(c => {
        const cat = cats[c];
        const subsHtml = (cat.subs && cat.subs.length > 0) 
            ? cat.subs.map(sub => `
                <div class="sub-item">
                    <span>â€¢ ${sub}</span>
                    <div>
                        <button onclick="moveSubCat('${c}','${sub}')" style="background:none;border:none;color:#1976d2;cursor:pointer;font-size:16px;margin-left:8px;" title="Ù†Ù‚Ù„">ğŸ“¦</button>
                        <button onclick="editSubCat('${c}','${sub}')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:16px;margin-left:8px;">âœï¸</button>
                        <button onclick="deleteSubCat('${c}','${sub}')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:16px;">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('')
            : '';
        
        return `
            <div style="background:var(--bg);padding:14px;border-radius:12px;margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <span style="font-size:17px;font-weight:800;">${cat.icon} ${c}</span>
                    <div>
                        <button onclick="editMainCat('${c}')" style="background:var(--accent);color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;margin-left:6px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="deleteMainCat('${c}')" style="background:var(--red);color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
                ${subsHtml}
                ${!cat.subs || cat.subs.length === 0 ? '<div style="color:var(--muted);font-size:12px;margin-right:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª ÙØ±Ø¹ÙŠØ©</div>' : ''}
            </div>
        `;
    }).join('');
    
    list.innerHTML = html || '<p style="text-align:center;color:var(--muted);padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª</p>';
}

function addMainCat() {
    const name = document.getElementById('catName').value.trim();
    const icon = document.getElementById('catIcon').value.trim() || selectedIcon || 'ğŸ“¦';
    
    if (!name) { toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ','err'); return; }
    if (cats[name]) { toast('Ø§Ù„ØªØµÙ†ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹','err'); return; }
    
    cats[name] = { icon, subs: [] };
    LS.set('cats', cats);
    saveCatsToSupabase();
    
    document.getElementById('catName').value = '';
    document.getElementById('catIcon').value = '';
    selectedIcon = '';
    document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('selected'));
    
    fillSubCatParentSelect();
    renderCats();
    toast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ');
}

function addSubCat() {
    const parent = document.getElementById('subCatParent').value;
    const name = document.getElementById('subCatName').value.trim();
    
    if (!parent) { toast('Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ','err'); return; }
    if (!name) { toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ','err'); return; }
    if (!cats[parent]) { toast('Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','err'); return; }
    
    if (!cats[parent].subs) cats[parent].subs = [];
    if (cats[parent].subs.includes(name)) { toast('Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹','err'); return; }
    
    cats[parent].subs.push(name);
    LS.set('cats', cats);
    saveCatsToSupabase();
    
    document.getElementById('subCatName').value = '';
    renderCats();
    toast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ');
}

function deleteMainCat(name) {
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${name}" ÙˆØ¬Ù…ÙŠØ¹ ØªØµÙ†ÙŠÙØ§ØªÙ‡ Ø§Ù„ÙØ±Ø¹ÙŠØ©ØŸ`)) return;
    delete cats[name];
    LS.set('cats', cats);
    saveCatsToSupabase();
    fillSubCatParentSelect();
    renderCats();
    toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');
}

function editMainCat(oldName) {
    const newName = prompt(`ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ:\n\nØ§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${oldName}`, oldName);
    if (!newName || newName.trim() === '') return;
    if (newName.trim() === oldName) return;
    if (cats[newName.trim()]) {
        toast('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹','err');
        return;
    }
    
    // Rename category
    cats[newName.trim()] = cats[oldName];
    delete cats[oldName];
    
    // Update expenses
    expenses.forEach(e => {
        if (e.main_cat === oldName) e.main_cat = newName.trim();
    });
    
    LS.set('cats', cats);
    LS.set('expenses', expenses);
    saveCatsToSupabase();
    if (!LOCAL_MODE && db) {
        db.from('expenses').update({ main_cat: newName.trim() }).eq('main_cat', oldName).eq('user_id', user.id);
    }
    
    fillSubCatParentSelect();
    renderCats();
    renderAll();
    toast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙ');
}

function deleteSubCat(parent, sub) {
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${sub}"ØŸ`)) return;
    cats[parent].subs = cats[parent].subs.filter(s => s !== sub);
    LS.set('cats', cats);
    saveCatsToSupabase();
    renderCats();
    toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');
}

function editSubCat(parent, oldSub) {
    const newSub = prompt(`ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ:\n\nØ§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${oldSub}`, oldSub);
    if (!newSub || newSub.trim() === '') return;
    if (newSub.trim() === oldSub) return;
    if (cats[parent].subs.includes(newSub.trim())) {
        toast('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹','err');
        return;
    }
    
    // Rename sub-category
    const index = cats[parent].subs.indexOf(oldSub);
    if (index !== -1) {
        cats[parent].subs[index] = newSub.trim();
    }
    
    // Update expenses
    expenses.forEach(e => {
        if (e.main_cat === parent && e.sub_cat === oldSub) {
            e.sub_cat = newSub.trim();
        }
    });
    
    allExpenses = expenses.slice();
    LS.set('cats', cats);
    LS.set('expenses', expenses);
    saveCatsToSupabase();
    if (!LOCAL_MODE && db) {
        db.from('expenses')
          .update({ sub_cat: newSub.trim() })
          .eq('main_cat', parent)
          .eq('sub_cat', oldSub)
          .eq('user_id', user.id);
    }
    
    renderCats();
    renderAll();
    toast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ');
}

async function moveSubCat(fromParent, subName) {
    // Get list of other categories
    const otherCats = Object.keys(cats).filter(c => c !== fromParent);
    
    if (otherCats.length === 0) {
        toast('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ø£Ø®Ø±Ù‰ Ù„Ù„Ù†Ù‚Ù„ Ø¥Ù„ÙŠÙ‡Ø§','err');
        return;
    }
    
    // Create selection dialog
    let message = `Ù†Ù‚Ù„ "${subName}" Ù…Ù† "${fromParent}" Ø¥Ù„Ù‰:\n\n`;
    otherCats.forEach((c, i) => {
        message += `${i + 1}. ${cats[c].icon} ${c}\n`;
    });
    message += `\nØ£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØµÙ†ÙŠÙ (1-${otherCats.length}):`;
    
    const choice = prompt(message);
    if (!choice) return;
    
    const index = parseInt(choice) - 1;
    if (isNaN(index) || index < 0 || index >= otherCats.length) {
        toast('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­','err');
        return;
    }
    
    const toParent = otherCats[index];
    
    // Check if sub already exists in target
    if (cats[toParent].subs && cats[toParent].subs.includes(subName)) {
        toast(`"${subName}" Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ "${toParent}"`, 'err');
        return;
    }
    
    // Move sub-category
    cats[fromParent].subs = cats[fromParent].subs.filter(s => s !== subName);
    if (!cats[toParent].subs) cats[toParent].subs = [];
    cats[toParent].subs.push(subName);
    
    // Update all expenses in both arrays
    let movedCount = 0;
    
    // Update expenses array
    expenses.forEach(e => {
        if (e.main_cat === fromParent && e.sub_cat === subName) {
            e.main_cat = toParent;
            movedCount++;
        }
    });
    
    // Update allExpenses array
    allExpenses.forEach(e => {
        if (e.main_cat === fromParent && e.sub_cat === subName) {
            e.main_cat = toParent;
        }
    });
    
    // Save categories
    LS.set('cats', cats);
    LS.set('expenses', expenses);
    saveCatsToSupabase();
    
    // Update Supabase expenses
    if (!LOCAL_MODE && db) {
        // Get all expenses that need to be updated
        const { data: expensesToUpdate } = await db.from('expenses')
          .select('id')
          .eq('main_cat', fromParent)
          .eq('sub_cat', subName)
          .eq('user_id', user.id);
        
        if (expensesToUpdate && expensesToUpdate.length > 0) {
            // Update each expense
            const updatePromises = expensesToUpdate.map(exp => 
                db.from('expenses')
                  .update({ main_cat: toParent })
                  .eq('id', exp.id)
            );
            await Promise.all(updatePromises);
        }
    }
    
    renderCats();
    renderAll();
    toast(`âœ… ØªÙ… Ù†Ù‚Ù„ "${subName}" Ø¥Ù„Ù‰ "${toParent}" (${movedCount} Ø¹Ù…Ù„ÙŠØ©)`);
}

async function saveCatsToSupabase() {
    if (LOCAL_MODE || !db) return;
    
    try {
        // Delete all existing categories
        await db.from('categories').delete().eq('user_id', user.id);
        
        // Insert all categories
        const catsArray = Object.keys(cats).map(name => ({
            user_id: user.id,
            name: name,
            icon: cats[name].icon,
            subs: cats[name].subs || []
        }));
        
        if (catsArray.length > 0) {
            await db.from('categories').insert(catsArray);
        }
    } catch(e) {
        console.error('Error saving categories:', e);
    }
}

// â”€â”€ Reports â”€â”€
let pieChartInstance = null;
let monthlyChartInstance = null;
let filteredExpenses = [];

function openReportsModal() {
    fillYearOptions();
    resetPeriod();
    openModal('reportsModal');
}

function fillYearOptions() {
    const years = [...new Set(expenses.map(e => e.date ? e.date.slice(0,4) : '').filter(Boolean))].sort().reverse();
    const sel = document.getElementById('repYear');
    sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>';
    years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
}

function resetPeriod() {
    document.getElementById('repYear').value = '';
    document.getElementById('repMonth').value = '';
    updateReports();
}

function updateReports() {
    const year = document.getElementById('repYear').value;
    const month = document.getElementById('repMonth').value;
    
    filteredExpenses = expenses.filter(e => {
        if (!e.date) return false;
        if (year && !e.date.startsWith(year)) return false;
        if (month && e.date.slice(5,7) !== month) return false;
        return true;
    });
    
    renderReportsData();
}

function renderReportsData() {
    // Summary
    const total = filteredExpenses.reduce((s,e) => s+(+e.amount||0), 0);
    const days = filteredExpenses.length > 0 ? 30 : 1;
    const avg = (total / days).toFixed(0);
    
    document.getElementById('repTotal').textContent = total.toLocaleString('ar-SA') + ' ï·¼';
    document.getElementById('repCount').textContent = filteredExpenses.length;
    document.getElementById('repAvg').textContent = (+avg).toLocaleString('ar-SA') + ' ï·¼';

    // Category breakdown
    const catTotals = {};
    filteredExpenses.forEach(e => {
        const c = e.main_cat || '';
        catTotals[c] = (catTotals[c]||0) + (+e.amount||0);
    });

    const sorted = Object.keys(catTotals).sort((a,b) => catTotals[b] - catTotals[a]);
    
    // Breakdown list
    const breakdown = document.getElementById('catBreakdown');
    if (sorted.length === 0) {
        breakdown.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    } else {
        breakdown.innerHTML = sorted.map(c => {
            const amt = catTotals[c];
            const pct = total > 0 ? ((amt/total)*100).toFixed(1) : 0;
            const cat = cats[c] || {icon:'ğŸ“¦'};
            return `
                <div style="margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="font-weight:700;">${cat.icon} ${c}</span>
                        <span style="font-weight:800;">${amt.toLocaleString('ar-SA')} ï·¼ (${pct}%)</span>
                    </div>
                    <div style="background:var(--border);height:8px;border-radius:99px;overflow:hidden;">
                        <div style="background:var(--accent);height:100%;width:${pct}%;border-radius:99px;"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Charts
    renderPieChart(sorted, catTotals);
    renderMonthlyChart();
}

function renderMonthlyChart() {
    const ctx = document.getElementById('monthlyChart');
    if (!ctx) return;
    
    if (monthlyChartInstance) monthlyChartInstance.destroy();

    // Get all months with expenses
    const monthlyData = {};
    expenses.forEach(e => {
        if (!e.date) return;
        const ym = e.date.slice(0,7); // YYYY-MM
        monthlyData[ym] = (monthlyData[ym]||0) + (+e.amount||0);
    });

    const sortedMonths = Object.keys(monthlyData).sort();
    const labels = sortedMonths.map(ym => {
        const [y,m] = ym.split('-');
        const monthNames = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
        return monthNames[parseInt(m)-1] + ' ' + y;
    });
    const data = sortedMonths.map(ym => monthlyData[ym]);

    monthlyChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø±ÙŠØ§Ù„)',
                data,
                borderColor: '#c8a96e',
                backgroundColor: 'rgba(200,169,110,0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { font: { family: 'Tajawal' } }
                },
                x: {
                    ticks: { font: { family: 'Tajawal', size: 11 } }
                }
            }
        }
    });
}

function renderPieChart(labels, data) {
    const ctx = document.getElementById('pieChart');
    if (!ctx) return;

    if (pieChartInstance) pieChartInstance.destroy();

    const colors = ['#c8a96e','#2d6a4f','#e63946','#4a90e2','#f59e0b','#8b5cf6','#ec4899','#10b981'];
    
    pieChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.map(l => {
                const cat = cats[l] || {icon:'ğŸ“¦'};
                return cat.icon + ' ' + l;
            }),
            datasets: [{
                data: labels.map(l => data[l]),
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    rtl: true,
                    labels: {
                        font: { family: 'Tajawal', size: 13 },
                        padding: 12,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

// â”€â”€ Card Statement â”€â”€
function showCardStatement() {
    const sel = document.getElementById('statCardSelect');
    sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...</option>';
    cards.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name||c.type}</option>`);
    
    // Fill years
    fillCardStatementYears();
    resetCardStatementPeriod();
    
    openModal('cardStatementModal');
}

function fillCardStatementYears() {
    const years = [...new Set(expenses.map(e => e.date ? e.date.slice(0,4) : '').filter(Boolean))].sort().reverse();
    const sel = document.getElementById('cardStatYear');
    sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>';
    years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
}

function resetCardStatementPeriod() {
    document.getElementById('cardStatYear').value = '';
    document.getElementById('cardStatMonth').value = '';
    renderCardStatement();
}

function renderCardStatement() {
    const cardId = document.getElementById('statCardSelect').value;
    if (!cardId) {
        document.getElementById('cardStatementContent').innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø©</p>';
        return;
    }

    const card = cards.find(c => String(c.id) === String(cardId));
    const year = document.getElementById('cardStatYear').value;
    const month = document.getElementById('cardStatMonth').value;
    
    // Filter expenses
    let cardExps = expenses.filter(e => String(e.card_id) === String(cardId));
    
    // Apply period filter
    if (year || month) {
        cardExps = cardExps.filter(e => {
            if (!e.date) return false;
            if (year && !e.date.startsWith(year)) return false;
            if (month && e.date.slice(5,7) !== month) return false;
            return true;
        });
    }
    
    cardExps.sort((a,b) => (b.date||'').localeCompare(a.date||''));
    const total = cardExps.reduce((s,e) => s+(+e.amount||0), 0);

    let html = `
        <div style="background:var(--bg);padding:16px;border-radius:12px;margin-bottom:16px;">
            <h3 style="font-size:18px;font-weight:900;margin-bottom:8px;">ğŸ’³ ${card.name||card.type}</h3>
            <div style="font-size:14px;color:var(--muted);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <strong style="color:var(--ink);">${total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</strong></div>
            <div style="font-size:14px;color:var(--muted);">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <strong style="color:var(--ink);">${cardExps.length}</strong></div>
        </div>
        <div style="max-height:400px;overflow-y:auto;">
            <table style="width:100%;border-collapse:collapse;">
                <thead style="background:var(--ink);color:#fff;position:sticky;top:0;">
                    <tr>
                        <th style="padding:10px;text-align:right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="padding:10px;text-align:right;">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                        <th style="padding:10px;text-align:right;">Ø§Ù„ÙˆØµÙ</th>
                        <th style="padding:10px;text-align:left;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    </tr>
                </thead>
                <tbody>
    `;

    cardExps.forEach((e,i) => {
        const cat = cats[e.main_cat] || {icon:'ğŸ“¦'};
        const bg = i % 2 === 0 ? 'var(--bg)' : '#fff';
        html += `
            <tr style="background:${bg};">
                <td style="padding:10px;">${e.date ? new Date(e.date).toLocaleDateString('ar-EG') : '-'}</td>
                <td style="padding:10px;">${cat.icon} ${e.main_cat||'-'}${e.sub_cat ? ' / '+e.sub_cat : ''}</td>
                <td style="padding:10px;font-size:13px;color:var(--muted);">${e.description||'-'}</td>
                <td style="padding:10px;text-align:left;font-weight:800;">${(+e.amount).toLocaleString('ar-SA')} ï·¼</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('cardStatementContent').innerHTML = html;
}

function exportCardStatement() {
    const cardId = document.getElementById('statCardSelect').value;
    if (!cardId) { toast('Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹','err'); return; }
    
    const card = cards.find(c => String(c.id) === String(cardId));
    const cardExps = expenses.filter(e => String(e.card_id) === String(cardId)).sort((a,b) => (b.date||'').localeCompare(a.date||''));
    
    let csv = `Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ØªØµÙ†ÙŠÙ,Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ,Ø§Ù„ÙˆØµÙ,Ø§Ù„Ù…Ø¨Ù„Øº\n`;
    cardExps.forEach(e => {
        csv += `${e.date||''},${e.main_cat||''},${e.sub_cat||''},${e.description||''},${e.amount||0}\n`;
    });
    
    const blob = new Blob(['\ufeff'+csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_${card.name||card.type}_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    toast('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±');
}

function printCardStatement() {
    const cardId = document.getElementById('statCardSelect').value;
    if (!cardId) { toast('Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹','err'); return; }
    
    const content = document.getElementById('cardStatementContent').innerHTML;
    const win = window.open('', '', 'width=800,height=600');
    win.document.write(`
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨</title>
            <style>
                body { font-family: Arial; padding: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; }
                th { background: #1a1a1a; color: white; }
            </style>
        </head>
        <body>${content}</body>
        </html>
    `);
    win.document.close();
    setTimeout(() => win.print(), 500);
}

// â”€â”€ Category Statement â”€â”€
function showCategoryStatement() {
    const sel = document.getElementById('statCatSelect');
    sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ...</option>';
    Object.keys(cats).forEach(c => {
        const cat = cats[c];
        sel.innerHTML += `<option value="${c}">${cat.icon} ${c}</option>`;
    });
    
    // Fill years
    fillCategoryStatementYears();
    resetCategoryStatementPeriod();
    
    openModal('categoryStatementModal');
}

function fillCategoryStatementYears() {
    const years = [...new Set(expenses.map(e => e.date ? e.date.slice(0,4) : '').filter(Boolean))].sort().reverse();
    const sel = document.getElementById('catStatYear');
    sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>';
    years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
}

function resetCategoryStatementPeriod() {
    document.getElementById('catStatYear').value = '';
    document.getElementById('catStatMonth').value = '';
    renderCategoryStatement();
}

function renderCategoryStatement() {
    const catName = document.getElementById('statCatSelect').value;
    if (!catName) {
        document.getElementById('categoryStatementContent').innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Ù‹</p>';
        return;
    }

    const cat = cats[catName];
    const year = document.getElementById('catStatYear').value;
    const month = document.getElementById('catStatMonth').value;
    
    // Filter expenses
    let catExps = expenses.filter(e => e.main_cat === catName);
    
    // Apply period filter
    if (year || month) {
        catExps = catExps.filter(e => {
            if (!e.date) return false;
            if (year && !e.date.startsWith(year)) return false;
            if (month && e.date.slice(5,7) !== month) return false;
            return true;
        });
    }
    
    catExps.sort((a,b) => (b.date||'').localeCompare(a.date||''));
    const total = catExps.reduce((s,e) => s+(+e.amount||0), 0);

    let html = `
        <div style="background:var(--bg);padding:16px;border-radius:12px;margin-bottom:16px;">
            <h3 style="font-size:18px;font-weight:900;margin-bottom:8px;">${cat.icon} ${catName}</h3>
            <div style="font-size:14px;color:var(--muted);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <strong style="color:var(--ink);">${total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</strong></div>
            <div style="font-size:14px;color:var(--muted);">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <strong style="color:var(--ink);">${catExps.length}</strong></div>
        </div>
        <div style="max-height:400px;overflow-y:auto;">
            <table style="width:100%;border-collapse:collapse;">
                <thead style="background:var(--ink);color:#fff;position:sticky;top:0;">
                    <tr>
                        <th style="padding:10px;text-align:right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="padding:10px;text-align:right;">Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ</th>
                        <th style="padding:10px;text-align:right;">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                        <th style="padding:10px;text-align:right;">Ø§Ù„ÙˆØµÙ</th>
                        <th style="padding:10px;text-align:left;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    </tr>
                </thead>
                <tbody>
    `;

    catExps.forEach((e,i) => {
        const card = cards.find(c => String(c.id) === String(e.card_id)) || {name:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'};
        const bg = i % 2 === 0 ? 'var(--bg)' : '#fff';
        html += `
            <tr style="background:${bg};">
                <td style="padding:10px;">${e.date ? new Date(e.date).toLocaleDateString('ar-EG') : '-'}</td>
                <td style="padding:10px;">${e.sub_cat||'-'}</td>
                <td style="padding:10px;">${card.name||card.type}</td>
                <td style="padding:10px;font-size:13px;color:var(--muted);">${e.description||'-'}</td>
                <td style="padding:10px;text-align:left;font-weight:800;">${(+e.amount).toLocaleString('ar-SA')} ï·¼</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('categoryStatementContent').innerHTML = html;
}

function exportCategoryStatement() {
    const catName = document.getElementById('statCatSelect').value;
    if (!catName) { toast('Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹','err'); return; }
    
    const catExps = expenses.filter(e => e.main_cat === catName).sort((a,b) => (b.date||'').localeCompare(a.date||''));
    
    let csv = `Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ,Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©,Ø§Ù„ÙˆØµÙ,Ø§Ù„Ù…Ø¨Ù„Øº\n`;
    catExps.forEach(e => {
        const card = cards.find(c => String(c.id) === String(e.card_id)) || {name:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'};
        csv += `${e.date||''},${e.sub_cat||''},${card.name||card.type},${e.description||''},${e.amount||0}\n`;
    });
    
    const blob = new Blob(['\ufeff'+csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_${catName}_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    toast('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±');
}

function printCategoryStatement() {
    const catName = document.getElementById('statCatSelect').value;
    if (!catName) { toast('Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹','err'); return; }
    
    const content = document.getElementById('categoryStatementContent').innerHTML;
    const win = window.open('', '', 'width=800,height=600');
    win.document.write(`
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ - ${catName}</title>
            <style>
                body { font-family: Arial; padding: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; }
                th { background: #1a1a1a; color: white; }
            </style>
        </head>
        <body>${content}</body>
        </html>
    `);
    win.document.close();
    setTimeout(() => win.print(), 500);
}

function exportExcel() {
    let csv = `Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ØªØµÙ†ÙŠÙ,Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ,Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©,Ø§Ù„ÙˆØµÙ,Ø§Ù„Ù…Ø¨Ù„Øº\n`;
    filteredExpenses.forEach(e => {
        const card = cards.find(c => String(c.id) === String(e.card_id)) || {name:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'};
        csv += `${e.date||''},${e.main_cat||''},${e.sub_cat||''},${card.name||card.type},${e.description||''},${e.amount||0}\n`;
    });
    
    const blob = new Blob(['\ufeff'+csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    toast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Excel');
}

function shareReport() {
    const total = filteredExpenses.reduce((s,e) => s+(+e.amount||0), 0);
    const catTotals = {};
    filteredExpenses.forEach(e => {
        const c = e.main_cat || '';
        catTotals[c] = (catTotals[c]||0) + (+e.amount||0);
    });
    
    const year = document.getElementById('repYear').value;
    const month = document.getElementById('repMonth').value;
    const monthNames = ['','ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
    const period = year && month ? `${monthNames[parseInt(month)]} ${year}` : year || month ? (year || monthNames[parseInt(month)]) : 'ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª';
    
    let report = `ğŸ“Š *ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ* - Ù…ØµØ±ÙˆÙØ§ØªÙŠ Ø¨Ø±Ùˆ
    
ğŸ‘¤ ${user.name}
ğŸ“… ${period}
ğŸ—“ï¸ ${new Date().toLocaleDateString('ar-EG')}

ğŸ’° *Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:*
â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString('ar-SA')} ï·¼
â€¢ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ${filteredExpenses.length}

ğŸ“Š *Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª:*
`;

    Object.keys(catTotals).sort((a,b) => catTotals[b]-catTotals[a]).forEach(c => {
        const cat = cats[c] || {icon:'ğŸ“¦'};
        const pct = total > 0 ? ((catTotals[c]/total)*100).toFixed(1) : 0;
        report += `${cat.icon} ${c}: ${catTotals[c].toLocaleString('ar-SA')} ï·¼ (${pct}%)
`;
    });

    report += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŒ https://masroofat-pro.netlify.app`;

    if (navigator.share) {
        navigator.share({ text: report }).catch(() => {});
    } else {
        navigator.clipboard.writeText(report);
        toast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    }
}

function exportPDF() {
    toast('ğŸ“„ Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ PDF...');
    
    const total = filteredExpenses.reduce((s,e) => s+(+e.amount||0), 0);
    const catTotals = {};
    filteredExpenses.forEach(e => {
        const c = e.main_cat || '';
        catTotals[c] = (catTotals[c]||0) + (+e.amount||0);
    });

    const year = document.getElementById('repYear').value;
    const month = document.getElementById('repMonth').value;
    const monthNames = ['','ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
    const period = year && month ? `${monthNames[parseInt(month)]} ${year}` : year || month ? (year || monthNames[parseInt(month)]) : 'ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª';

    let html = `
    <html dir="rtl">
    <head>
        <meta charset="UTF-8">
        <style>
            body { font-family: Arial; padding: 40px; }
            h1 { color: #1a1a1a; border-bottom: 3px solid #c8a96e; padding-bottom: 10px; }
            .stat { background: #f4f1ec; padding: 15px; margin: 10px 0; border-radius: 8px; }
            .cat { margin: 12px 0; padding: 10px; background: #fff; border-right: 4px solid #c8a96e; }
        </style>
    </head>
    <body>
        <h1>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h1>
        <p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${user.name}</p>
        <p><strong>Ø§Ù„ÙØªØ±Ø©:</strong> ${period}</p>
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
        
        <h2>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <div class="stat">
            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:</strong> ${total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„<br>
            <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</strong> ${filteredExpenses.length}
        </div>

        <h2>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h2>
    `;

    Object.keys(catTotals).sort((a,b) => catTotals[b]-catTotals[a]).forEach(c => {
        const cat = cats[c] || {icon:'ğŸ“¦'};
        const pct = total > 0 ? ((catTotals[c]/total)*100).toFixed(1) : 0;
        html += `<div class="cat">${cat.icon} <strong>${c}:</strong> ${catTotals[c].toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„ (${pct}%)</div>`;
    });

    html += `
        <hr style="margin: 30px 0;">
        <p style="text-align:center;color:#888;">Ù…ØµØ±ÙˆÙØ§ØªÙŠ Ø¨Ø±Ùˆ - https://masroofat-pro.netlify.app</p>
    </body>
    </html>`;

    const win = window.open('', '', 'width=800,height=600');
    win.document.write(html);
    win.document.close();
    setTimeout(() => {
        win.print();
        toast('âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
    }, 500);
}

// â”€â”€ Modals â”€â”€
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// â”€â”€ Init â”€â”€
window.onload = () => {
    const u = localStorage.getItem('mp_current');
    if (u) {
        try { startApp(JSON.parse(u)); } catch(e) { localStorage.removeItem('mp_current'); }
    }
};
</script>
</body>
</html>
